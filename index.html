<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quem √© o Craque? (V5 - Online)</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React e ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    
    <style>
        /* Estilo base para a p√°gina enquanto o React carrega */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #root {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #111827; /* bg-gray-900 */
        }
        .loading-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- O React ir√° controlar este elemento -->
    <div id="root">
        <div class="loading-text">A carregar o jogo...</div>
    </div>

    <!-- 4. O nosso c√≥digo React (V5) -->
    <script type="module">
        // Importa as fun√ß√µes do Firebase a partir dos scripts carregados
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            collection, 
            writeBatch,
            deleteDoc,
            query,
            serverTimestamp,
            deleteField,
            arrayUnion 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // O React e o ReactDOM est√£o dispon√≠veis globalmente (window.React, window.ReactDOM)
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Configura√ß√£o do Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-quem-e-craque';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        let app, dbGlobal, authGlobal;
        try {
            app = initializeApp(firebaseConfig);
            dbGlobal = getFirestore(app);
            authGlobal = getAuth(app);
            setLogLevel('debug'); // Ativa logs detalhados
            console.log("Firebase inicializado com sucesso.");
        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
            document.getElementById('root').innerHTML = '<div class="loading-text" style="color: red;">Erro na configura√ß√£o do Firebase. Verifique as credenciais.</div>';
        }


        // --- Banco de Dados de Jogadores ---
        const allPlayers = [
          // Exemplos com imagens reais (links de exemplo, podem quebrar)
          { id: 1, name: 'Messi', attributes: ['Argentino', 'Atacante', 'Joga na MLS', 'Canhoto', 'Baixo'], imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Lionel_Messi_WC2022.jpg/440px-Lionel_Messi_WC2022.jpg' },
          { id: 2, name: 'Cristiano Ronaldo', attributes: ['Portugu√™s', 'Atacante', 'Joga na Ar√°bia Saudita', 'Destro', 'Alto'], imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d7/Cristiano_Ronaldo_playing_for_Al_Nassr_FC_against_Persepolis%2C_19_September_2023_%28cropped%29.jpg/440px-Cristiano_Ronaldo_playing_for_Al_Nassr_FC_against_Persepolis%2C_19_September_2023_%28cropped%29.jpg' },
          { id: 3, name: 'Pel√©', attributes: ['Brasileiro', 'Atacante', 'Aposentado', 'Destro', 'Baixo'], imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Pele_con_la_camiseta_de_Brasil_en_1970.jpg/440px-Pele_con_la_camiseta_de_Brasil_en_1970.jpg' },
          
          // Restante com placeholders
          { id: 4, name: 'Maradona', attributes: ['Argentino', 'Meio-campista', 'Aposentado', 'Canhoto', 'Baixo'], imageUrl: 'https://placehold.co/200x200/3498db/ffffff?text=Maradona' },
          { id: 5, name: 'Neymar', attributes: ['Brasileiro', 'Atacante', 'Joga na Ar√°bia Saudita', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/f1c40f/000000?text=Neymar' },
          { id: 6, name: 'Mbapp√©', attributes: ['Franc√™s', 'Atacante', 'Joga na Espanha', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/34495e/ffffff?text=Mbapp%C3%A9' },
          { id: 7, name: 'Haaland', attributes: ['Noruegu√™s', 'Atacante', 'Joga na Inglaterra', 'Canhoto', 'Alto'], imageUrl: 'https://placehold.co/200x200/1abc9c/ffffff?text=Haaland' },
          { id: 8, name: 'Vin√≠cius Jr', attributes: ['Brasileiro', 'Atacante', 'Joga na Espanha', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/f1c40f/000000?text=Vini+Jr' },
          { id: 9, name: 'Kevin De Bruyne', attributes: ['Belga', 'Meio-campista', 'Joga na Inglaterra', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/e67e22/ffffff?text=KDB' },
          { id: 10, name: 'Zidane', attributes: ['Franc√™s', 'Meio-campista', 'Aposentado', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/34495e/ffffff?text=Zidane' },
          { id: 11, name: 'Ronaldo Fen√¥meno', attributes: ['Brasileiro', 'Atacante', 'Aposentado', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/f1c40f/000000?text=R9' },
          { id: 12, name: 'Ronaldinho', attributes: ['Brasileiro', 'Meio-campista', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/f1c40f/000000?text=R10' },
          { id: 13, name: 'Johan Cruyff', attributes: ['Holand√™s', 'Atacante', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/e67e22/ffffff?text=Cruyff' },
          { id: 14, name: 'Beckenbauer', attributes: ['Alem√£o', 'Defensor', 'Aposentado', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/2c3e50/ffffff?text=Beckenbauer' },
          { id: 15, name: 'Paolo Maldini', attributes: ['Italiano', 'Defensor', 'Aposentado', 'Canhoto', 'Alto'], imageUrl: 'https://placehold.co/200x200/3498db/ffffff?text=Maldini' },
          { id: 16, name: 'Lev Yashin', attributes: ['Russo', 'Goleiro', 'Aposentado', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/c0392b/ffffff?text=Yashin' },
          { id: 17, name: 'Gerd M√ºller', attributes: ['Alem√£o', 'Atacante', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/2c3e50/ffffff?text=M%C3%BCller' },
          { id: 18, name: 'Ferenc Pusk√°s', attributes: ['H√∫ngaro', 'Atacante', 'Aposentado', 'Canhoto', 'Baixo'], imageUrl: 'https://placehold.co/200x200/e74c3c/ffffff?text=Pusk%C3%A1s' },
          { id: 19, name: 'George Best', attributes: ['Norte-irland√™s', 'Atacante', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/2ecc71/ffffff?text=Best' },
          { id: 20, name: 'Eus√©bio', attributes: ['Portugu√™s', 'Atacante', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/e74c3c/ffffff?text=Eus%C3%A9bio' },
          { id: 21, name: 'Di St√©fano', attributes: ['Argentino', 'Atacante', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/ecf0f1/000000?text=Di+St%C3%A9fano' },
          { id: 22, name: 'Michel Platini', attributes: ['Franc√™s', 'Meio-campista', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/34495e/ffffff?text=Platini' },
          { id: 23, name: 'Bobby Charlton', attributes: ['Ingl√™s', 'Meio-campista', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/ecf0f1/000000?text=Charlton' },
          { id: 24, name: 'Garrincha', attributes: ['Brasileiro', 'Atacante', 'Aposentado', 'Destro', 'Baixo'], imageUrl: 'https://placehold.co/200x200/f1c40f/000000?text=Garrincha' },
          { id: 25, name: 'Zico', attributes: ['Brasileiro', 'Meio-campista', 'Aposentado', 'Destro', 'Baixo'], imageUrl: 'https://placehold.co/200x200/f1c40f/000000?text=Zico' },
          { id: 26, name: 'Rom√°rio', attributes: ['Brasileiro', 'Atacante', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/f1c40f/000000?text=Rom%C3%A1rio' },
          { id: 27, name: 'Van Basten', attributes: ['Holand√™s', 'Atacante', 'Aposentado', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/e67e22/ffffff?text=Van+Basten' },
          { id: 28, name: 'Thierry Henry', attributes: ['Franc√™s', 'Atacante', 'Aposentado', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/34495e/ffffff?text=Henry' },
          { id: 29, name: 'Andr√©s Iniesta', attributes: ['Espanhol', 'Meio-campista', 'Ativo', 'Destro', 'Baixo'], imageUrl: 'https://placehold.co/200x200/c0392b/ffffff?text=Iniesta' },
          { id: 30, name: 'Xavi', attributes: ['Espanhol', 'Meio-campista', 'Aposentado', 'Destro', 'Baixo'], imageUrl: 'https://placehold.co/200x200/c0392b/ffffff?text=Xavi' },
          { id: 31, name: 'Bellingham', attributes: ['Ingl√™s', 'Meio-campista', 'Joga na Espanha', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/ecf0f1/000000?text=Bellingham' },
          { id: 32, name: 'Modric', attributes: ['Croata', 'Meio-campista', 'Joga na Espanha', 'Destro', 'Baixo'], imageUrl: 'https://placehold.co/200x200/ecf0f1/000000?text=Modric' },
          { id: 33, name: 'Salah', attributes: ['Eg√≠pcio', 'Atacante', 'Joga na Inglaterra', 'Canhoto', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/e74c3c/ffffff?text=Salah' },
          { id: 34, name: 'Buffon', attributes: ['Italiano', 'Goleiro', 'Aposentado', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/3498db/ffffff?text=Buffon' },
          { id: 35, name: 'Neuer', attributes: ['Alem√£o', 'Goleiro', 'Joga na Alemanha', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/2c3e50/ffffff?text=Neuer' },
          { id: 36, name: 'Kahn', attributes: ['Alem√£o', 'Goleiro', 'Aposentado', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/2c3e50/ffffff?text=Kahn' },
          { id: 37, name: 'Cafu', attributes: ['Brasileiro', 'Defensor', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/f1c40f/000000?text=Cafu' },
          { id: 38, name: 'Roberto Carlos', attributes: ['Brasileiro', 'Defensor', 'Aposentado', 'Canhoto', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/f1c40f/000000?text=R.+Carlos' },
          { id: 39, name: 'Puyol', attributes: ['Espanhol', 'Defensor', 'Aposentado', 'Destro', 'M√©dio'], imageUrl: 'https://placehold.co/200x200/c0392b/ffffff?text=Puyol' },
          { id: 40, name: 'Sergio Ramos', attributes: ['Espanhol', 'Defensor', 'Joga na Espanha', 'Destro', 'Alto'], imageUrl: 'https://placehold.co/200x200/c0392b/ffffff?text=S.+Ramos' },
          // ... (Continuar a preencher at√© 300)
        ];

        // --- Fun√ß√µes Auxiliares ---

        function shuffleArray(array) {
          let currentIndex = array.length,  randomIndex;
          while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [
              array[randomIndex], array[currentIndex]];
          }
          return array;
        }

        function generateGameId() {
          return Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        // --- Caminhos do Firestore ---
        const getGamesCollectionRef = (db) => collection(db, 'artifacts', appId, 'public', 'data', 'quem-e-o-craque-v5-games');
        const getGameDocRef = (db, gameId) => doc(db, 'artifacts', appId, 'public', 'data', 'quem-e-o-craque-v5-games', gameId);
        const getLobbyCollectionRef = (db, gameId) => collection(db, 'artifacts', appId, 'public', 'data', 'quem-e-o-craque-v5-games', gameId, 'lobby');
        const getPlayerDocRef = (db, gameId, userId) => doc(db, 'artifacts', appId, 'public', 'data', 'quem-e-o-craque-v5-games', gameId, 'lobby', userId);

        // --- Componente Principal ---

        function App() {
          const [auth, setAuth] = useState(null);
          const [db, setDb] = useState(null);
          const [userId, setUserId] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          
          const [gameId, setGameId] = useState(null);
          const [gameData, setGameData] = useState(null);
          const [playersInLobby, setPlayersInLobby] = useState([]);
          
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);
          const [gameIdInput, setGameIdInput] = useState('');

          const [eliminatedCards, setEliminatedCards] = useState({});
          const [guessModalOpen, setGuessModalOpen] = useState(false);

          // Efeito para inicializar o Firebase e autenticar
          useEffect(() => {
            if (!authGlobal || !dbGlobal) {
                setError("Falha ao carregar a configura√ß√£o do Firebase.");
                return;
            }
              
            setDb(dbGlobal);
            setAuth(authGlobal);

            const unsubscribe = onAuthStateChanged(authGlobal, async (user) => {
              if (user) {
                setUserId(user.uid);
                setIsAuthReady(true);
                console.log("Utilizador autenticado:", user.uid);
              } else {
                try {
                  console.log("Nenhum utilizador, a tentar autentica√ß√£o...");
                  if (initialAuthToken) {
                    console.log("A usar token inicial.");
                    await signInWithCustomToken(authGlobal, initialAuthToken);
                  } else {
                    console.log("A usar autentica√ß√£o an√≥nima.");
                    await signInAnonymously(authGlobal);
                  }
                } catch (err) {
                  console.error("Erro na autentica√ß√£o:", err);
                  setError("Erro ao ligar. Por favor, atualize a p√°gina.");
                }
              }
            });

            return () => unsubscribe();
          }, []);

          // Efeito para "ouvir" os dados do jogo (documento principal)
          useEffect(() => {
            if (!isAuthReady || !db || !gameId) {
              setGameData(null);
              return;
            }

            console.log(`A ouvir o documento do jogo: ${gameId}`);
            const gameDocRef = getGameDocRef(db, gameId);
            
            const unsubscribe = onSnapshot(gameDocRef, (docSnap) => {
              if (docSnap.exists()) {
                const data = docSnap.data();
                setGameData(data);
                console.log("Dados do jogo atualizados:", data);
                if (data.status === 'playing') {
                  setEliminatedCards({});
                }
              } else {
                console.warn(`O jogo ${gameId} n√£o foi encontrado.`);
                setError(`Sala ${gameId} n√£o encontrada. Foi eliminada?`);
                setGameId(null);
                setGameData(null);
              }
            }, (err) => {
              console.error("Erro ao ouvir o jogo:", err);
              setError("Erro de liga√ß√£o com a sala.");
            });

            return () => unsubscribe();
          }, [isAuthReady, db, gameId]);

          // Efeito para "ouvir" quem est√° no lobby (subcole√ß√£o 'lobby')
          useEffect(() => {
            if (!isAuthReady || !db || !gameId) {
              setPlayersInLobby([]);
              return;
            }

            console.log(`A ouvir o lobby da sala: ${gameId}`);
            const lobbyColRef = getLobbyCollectionRef(db, gameId);
            
            const unsubscribe = onSnapshot(query(lobbyColRef), (querySnapshot) => {
              const players = [];
              querySnapshot.forEach((doc) => {
                players.push({ id: doc.id, ...doc.data() });
              });
              setPlayersInLobby(players);
              console.log("Jogadores no lobby atualizados:", players);
            }, (err) => {
              console.error("Erro ao ouvir o lobby:", err);
              setError("Erro ao carregar os jogadores na sala.");
            });

            return () => unsubscribe();
          }, [isAuthReady, db, gameId]);

          // --- Fun√ß√µes de Gest√£o do Jogo ---

          const handleCreateGame = useCallback(async () => {
            if (!isAuthReady || !db || !userId) return;

            setLoading(true);
            setError(null);
            const newGameId = generateGameId();
            console.log(`A criar jogo: ${newGameId}`);
            
            try {
              const gameDocRef = getGameDocRef(db, newGameId);
              const playerDocRef = getPlayerDocRef(db, newGameId, userId);
              const batch = writeBatch(db);

              batch.set(gameDocRef, {
                hostId: userId,
                status: 'lobby',
                createdAt: serverTimestamp(),
                board: [],
                secretPlayers: {},
                winners: []
              });

              batch.set(playerDocRef, {
                joinedAt: serverTimestamp(),
                isHost: true
              });

              await batch.commit();
              setGameId(newGameId);
              console.log(`Jogo ${newGameId} criado.`);
            } catch (err) {
              console.error("Erro ao criar jogo:", err);
              setError("N√£o foi poss√≠vel criar o jogo. Tente novamente.");
            } finally {
              setLoading(false);
            }
          }, [isAuthReady, db, userId]);

          const handleJoinGame = useCallback(async (idToJoin) => {
            if (!isAuthReady || !db || !userId || !idToJoin) return;

            setLoading(true);
            setError(null);
            const normalizedId = idToJoin.toUpperCase();
            console.log(`A tentar entrar no jogo: ${normalizedId}`);
            
            try {
              const gameDocRef = getGameDocRef(db, normalizedId);
              const gameSnap = await getDoc(gameDocRef);

              if (!gameSnap.exists()) throw new Error("Sala n√£o encontrada.");
              if (gameSnap.data().status !== 'lobby') throw new Error("Este jogo j√° come√ßou ou terminou.");

              const playerDocRef = getPlayerDocRef(db, normalizedId, userId);
              await setDoc(playerDocRef, {
                joinedAt: serverTimestamp(),
                isHost: false
              });

              setGameId(normalizedId);
              console.log(`Entrou no jogo ${normalizedId}.`);
            } catch (err) {
              console.error("Erro ao entrar no jogo:", err);
              setError(err.message || "N√£o foi poss√≠vel entrar no jogo. Verifique o ID.");
            } finally {
              setLoading(false);
            }
          }, [isAuthReady, db, userId]);

          const handleStartGame = useCallback(async () => {
            if (!gameId || !db || !userId || playersInLobby.length === 0 || gameData?.hostId !== userId) {
              if (gameData?.hostId !== userId) setError("Apenas o anfitri√£o pode come√ßar o jogo.");
              return;
            }

            setLoading(true);
            setError(null);
            console.log(`A come√ßar o jogo ${gameId}...`);

            try {
              const shuffledAllPlayers = shuffleArray([...allPlayers]);
              const gameBoard = shuffledAllPlayers.slice(0, 25);
              const shuffledBoard = shuffleArray([...gameBoard]);
              const secretPlayersMap = {};
              
              playersInLobby.forEach((player, index) => {
                const secretPlayer = shuffledBoard[index % shuffledBoard.length];
                secretPlayersMap[player.id] = secretPlayer.id;
              });

              const gameDocRef = getGameDocRef(db, gameId);
              await updateDoc(gameDocRef, {
                status: 'playing',
                board: gameBoard,
                secretPlayers: secretPlayersMap,
                winners: []
              });
              
              console.log("Jogo iniciado com sucesso.");
            } catch (err) {
              console.error("Erro ao come√ßar o jogo:", err);
              setError("N√£o foi poss√≠vel come√ßar o jogo.");
            } finally {
              setLoading(false);
            }
          }, [gameId, db, userId, playersInLobby, gameData]);

          const handleLeaveGame = useCallback(async () => {
            if (!gameId || !db || !userId) return;
            console.log(`A sair do jogo ${gameId}...`);
            
            try {
              const playerDocRef = getPlayerDocRef(db, gameId, userId);
              await deleteDoc(playerDocRef);

              if (gameData?.hostId === userId && playersInLobby.length > 1) {
                  const newHost = playersInLobby.find(p => p.id !== userId);
                  if (newHost) {
                      const gameDocRef = getGameDocRef(db, gameId);
                      await updateDoc(gameDocRef, { hostId: newHost.id });
                      const newHostPlayerDocRef = getPlayerDocRef(db, gameId, newHost.id);
                      await updateDoc(newHostPlayerDocRef, { isHost: true });
                      console.log(`Novo anfitri√£o eleito: ${newHost.id}`);
                  }
              } else if (playersInLobby.length <= 1) {
                  console.log("√öltimo jogador saiu. A apagar o jogo.");
                  const gameDocRef = getGameDocRef(db, gameId);
                  await deleteDoc(gameDocRef);
              }

              setGameId(null);
              setGameData(null);
              setPlayersInLobby([]);
              setError(null);
            } catch (err) {
              console.error("Erro ao sair do jogo:", err);
              setError("N√£o foi poss√≠vel sair do jogo.");
            }
          }, [gameId, db, userId, gameData, playersInLobby]);

          const handleToggleCard = (playerId) => {
            setEliminatedCards(prev => ({ ...prev, [playerId]: !prev[playerId] }));
          };

          const handleGuess = useCallback(async (guessedPlayerId) => {
            if (!gameData || !userId || !db || !gameId) return;

            const mySecretPlayerId = gameData.secretPlayers[userId];
            
            if (guessedPlayerId === mySecretPlayerId) {
              console.log("Palpite correto!");
              const gameDocRef = getGameDocRef(db, gameId);
              await updateDoc(gameDocRef, { winners: arrayUnion(userId) });
              
              if (gameData.winners.length + 1 === playersInLobby.length) {
                await updateDoc(gameDocRef, { status: 'finished' });
              }
            } else {
              console.log("Palpite incorreto.");
            }
            setGuessModalOpen(false);
          }, [gameData, userId, db, gameId, playersInLobby]);

          // --- Renderiza√ß√£o ---
          const mySecretPlayerId = useMemo(() => gameData?.secretPlayers?.[userId], [gameData, userId]);
          const amIWinner = useMemo(() => gameData?.winners.includes(userId), [gameData, userId]);
          const amIHost = useMemo(() => gameData?.hostId === userId, [gameData, userId]);

          // Renderiza o Ecr√£ de Entrada (Lobby Principal)
          const renderLobby = () => (
            React.createElement('div', { className: "w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-xl" },
              React.createElement('h2', { className: "text-3xl font-bold text-center text-gray-800" }, "Quem √© o Craque?"),
              React.createElement('p', { className: "text-center text-gray-600" }, "Crie uma sala ou junte-se a uma existente para jogar com os seus amigos!"),
              error && React.createElement('div', { className: "p-3 text-center text-red-800 bg-red-100 rounded-md" }, error),
              React.createElement('button', {
                onClick: handleCreateGame,
                disabled: loading,
                className: "w-full px-4 py-3 font-semibold text-white transition duration-300 transform bg-green-600 rounded-md shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:bg-gray-400 hover:scale-105"
              }, loading ? 'A criar...' : 'Criar Novo Jogo'),
              React.createElement('div', { className: "flex items-center justify-center space-x-2" },
                React.createElement('hr', { className: "w-full border-gray-300" }),
                React.createElement('span', { className: "font-medium text-gray-500" }, "OU"),
                React.createElement('hr', { className: "w-full border-gray-300" })
              ),
              React.createElement('div', { className: "space-y-3" },
                React.createElement('input', {
                  type: "text",
                  value: gameIdInput,
                  onChange: (e) => setGameIdInput(e.target.value.toUpperCase()),
                  maxLength: "5",
                  placeholder: "C√≥digo da Sala (Ex: ABC12)",
                  className: "w-full px-4 py-3 text-center uppercase border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                }),
                React.createElement('button', {
                  onClick: () => handleJoinGame(gameIdInput),
                  disabled: loading || gameIdInput.length < 5,
                  className: "w-full px-4 py-3 font-semibold text-white transition duration-300 transform bg-blue-600 rounded-md shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-400 hover:scale-105"
                }, loading ? 'A entrar...' : 'Entrar no Jogo')
              ),
              React.createElement('p', { className: "text-xs text-center text-gray-500" }, `O seu ID de Jogador: ${userId}`)
            )
          );

          // Renderiza o Jogo (Lobby da Sala ou Jogo a Decorrer)
          const renderGame = () => {
            if (!gameData) {
              return React.createElement('div', { className: "text-white" },
                React.createElement('p', null, "A carregar dados da sala..."),
                error && React.createElement('div', { className: "p-3 text-center text-red-800 bg-red-100 rounded-md" }, error),
                React.createElement('button', { onClick: handleLeaveGame, className: "px-4 py-2 mt-4 font-semibold text-white bg-red-600 rounded-md hover:bg-red-700" }, "Sair")
              );
            }
            
            if (gameData.status === 'lobby') {
              return React.createElement('div', { className: "w-full max-w-lg p-8 space-y-6 bg-white rounded-lg shadow-xl" },
                React.createElement('h2', { className: "text-2xl font-bold text-center text-gray-800" }, "Sala de Jogo: ", React.createElement('span', { className: "font-mono text-blue-600" }, gameId)),
                React.createElement('p', { className: "text-center text-gray-600" }, "A aguardar jogadores... Partilhe o c√≥digo com os seus amigos!"),
                React.createElement('div', { className: "p-4 border border-gray-200 rounded-md" },
                  React.createElement('h3', { className: "mb-2 font-semibold text-gray-700" }, `Jogadores na Sala (${playersInLobby.length}):`),
                  React.createElement('ul', { className: "space-y-1" },
                    playersInLobby.map(player => (
                      React.createElement('li', { key: player.id, className: "flex items-center justify-between p-2 bg-gray-50 rounded-md" },
                        React.createElement('span', { className: "truncate" },
                          `${player.id.substring(0, 8)}...`,
                          player.id === userId && React.createElement('span', { className: "font-semibold text-blue-600" }, " (Voc√™)"),
                          player.isHost && React.createElement('span', { className: "ml-2 text-xs font-bold text-yellow-600" }, "[Anfitri√£o]")
                        )
                      )
                    ))
                  )
                ),
                error && React.createElement('div', { className: "p-3 text-center text-red-800 bg-red-100 rounded-md" }, error),
                React.createElement('button', {
                  onClick: handleStartGame,
                  disabled: loading || playersInLobby.length < 2 || !amIHost,
                  className: "w-full px-4 py-3 font-bold text-white transition duration-300 transform bg-green-600 rounded-md shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed hover:scale-105"
                }, loading ? 'A come√ßar...' : 'Come√ßar Jogo!'),
                !amIHost && React.createElement('p', { className: "text-xs text-center text-gray-500" }, "Apenas o anfitri√£o pode come√ßar o jogo."),
                playersInLobby.length < 2 && React.createElement('p', { className: "text-xs text-center text-gray-500" }, "√â necess√°rio pelo menos 2 jogadores para come√ßar."),
                React.createElement('button', { onClick: handleLeaveGame, className: "w-full px-4 py-2 mt-4 font-semibold text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300" }, "Sair da Sala")
              );
            }
            
            if (gameData.status === 'playing' || gameData.status === 'finished') {
              const mySecretPlayer = allPlayers.find(p => p.id === mySecretPlayerId);
              const otherPlayersSecrets = Object.entries(gameData.secretPlayers)
                .filter(([pUserId, _]) => pUserId !== userId)
                .map(([pUserId, pPlayerId]) => {
                    const playerDetails = allPlayers.find(p => p.id === pPlayerId);
                    return {
                        userId: pUserId,
                        playerName: playerDetails ? playerDetails.name : 'Desconhecido',
                        imageUrl: playerDetails ? playerDetails.imageUrl : 'https://placehold.co/100x100'
                    };
                });

              return React.createElement('div', { className: "w-full max-w-6xl p-6 mx-auto" },
                gameData.status === 'finished' && React.createElement('div', { className: "p-4 mb-6 text-2xl font-bold text-center text-green-800 bg-green-100 rounded-lg shadow-lg" }, "FIM DE JOGO!"),
                React.createElement('div', { className: "grid grid-cols-1 gap-6 mb-6 md:grid-cols-3" },
                  React.createElement('div', { className: "p-4 bg-white rounded-lg shadow-lg" },
                    React.createElement('h3', { className: "mb-2 text-lg font-bold text-center text-gray-800" }, "O SEU OBJETIVO"),
                    amIWinner ? (
                      React.createElement('div', { className: "text-center" },
                        React.createElement('img', { 
                          src: mySecretPlayer.imageUrl, 
                          alt: mySecretPlayer.name, 
                          className: "object-cover w-32 h-32 mx-auto mb-2 border-4 border-green-500 rounded-full shadow-md",
                          onError: (e) => { e.target.onerror = null; e.target.src='https://placehold.co/200x200/cccccc/999999?text=Erro'; }
                        }),
                        React.createElement('p', { className: "text-xl font-bold text-green-600" }, "VOC√ä ADIVINHOU!"),
                        React.createElement('p', { className: "text-lg font-semibold" }, mySecretPlayer.name)
                      )
                    ) : (
                      React.createElement('div', { className: "p-6 text-center bg-gray-800 rounded-lg" },
                        React.createElement('span', { className: "text-6xl font-bold text-white" }, "?"),
                        React.createElement('p', { className: "mt-2 font-semibold text-white" }, "O seu jogador √© ???"),
                        React.createElement('p', { className: "text-sm text-gray-300" }, "(Pergunte aos seus amigos!)")
                      )
                    )
                  ),
                  React.createElement('div', { className: "p-4 bg-white rounded-lg shadow-lg md:col-span-2" },
                    React.createElement('h3', { className: "mb-2 text-lg font-bold text-center text-gray-800" }, "QUEM OS SEUS AMIGOS S√ÉO:"),
                    React.createElement('div', { className: "flex flex-wrap items-start justify-center gap-4" },
                      otherPlayersSecrets.length === 0 ? (
                          React.createElement('p', { className: "text-gray-500" }, "A aguardar outros jogadores...")
                      ) : (
                          otherPlayersSecrets.map(p => (
                              React.createElement('div', { key: p.userId, className: "p-2 text-center bg-gray-50 rounded-md shadow-sm w-36" },
                                React.createElement('img', { 
                                  src: p.imageUrl, 
                                  alt: p.playerName, 
                                  className: "object-cover w-20 h-20 mx-auto mb-1 rounded-full shadow-md",
                                  onError: (e) => { e.target.onerror = null; e.target.src='https://placehold.co/200x200/cccccc/999999?text=Erro'; }
                                }),
                                React.createElement('p', { className: "text-sm font-semibold text-gray-700 truncate" }, p.playerName),
                                React.createElement('p', { className: "text-xs text-gray-500 truncate" }, `${p.userId.substring(0, 8)}...`)
                              )
                          ))
                      )
                    )
                  )
                ),
                gameData.winners && gameData.winners.length > 0 && (
                    React.createElement('div', { className: "p-4 mb-6 bg-yellow-100 rounded-lg shadow-md" },
                        React.createElement('h3', { className: "mb-2 text-lg font-bold text-center text-yellow-800" }, "üèÜ Vencedores üèÜ"),
                        React.createElement('div', { className: "flex flex-wrap justify-center gap-4" },
                            gameData.winners.map(winnerId => (
                                React.createElement('span', { key: winnerId, className: "px-3 py-1 font-semibold text-green-800 bg-green-200 rounded-full shadow-sm" },
                                    `${winnerId.substring(0, 8)}... ${winnerId === userId ? "(Voc√™)" : ""}`
                                )
                            ))
                        )
                    )
                ),
                React.createElement('div', { className: "grid grid-cols-5 gap-2 md:gap-4 p-4 bg-gray-900 rounded-lg shadow-inner" },
                  gameData.board.map(player => (
                    React.createElement(GameCard, {
                      key: player.id,
                      player: player,
                      isEliminated: !!eliminatedCards[player.id],
                      onClick: () => handleToggleCard(player.id)
                    })
                  ))
                ),
                React.createElement('div', { className: "flex flex-col gap-4 mt-6 md:flex-row" },
                  React.createElement('button', {
                    onClick: () => setGuessModalOpen(true),
                    disabled: amIWinner || gameData.status === 'finished',
                    className: "flex-1 px-6 py-4 text-xl font-bold text-white transition duration-300 transform bg-green-600 rounded-md shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed hover:scale-105"
                  }, amIWinner ? "Voc√™ J√° Venceu!" : "Dar Palpite!"),
                  React.createElement('button', { 
                      onClick: handleLeaveGame, 
                      className: "flex-1 px-6 py-4 font-semibold text-gray-700 bg-gray-200 rounded-md shadow-lg hover:bg-gray-300"
                  }, "Sair do Jogo")
                ),
                guessModalOpen && React.createElement(GuessModal, {
                  board: gameData.board,
                  onClose: () => setGuessModalOpen(false),
                  onGuess: handleGuess
                })
              );
            }
            return React.createElement('div', { className: "text-white" }, `Estado de jogo desconhecido: ${gameData.status}`);
          };

          // --- Renderiza√ß√£o Principal ---
          if (!isAuthReady || !db || !auth) {
            return React.createElement('div', { className: "flex items-center justify-center min-h-screen bg-gray-900" },
              React.createElement('div', { className: "text-2xl font-semibold text-white" }, error || "A ligar ao servidor...")
            );
          }

          return React.createElement('div', { className: "flex items-center justify-center min-h-screen p-4 bg-gradient-to-b from-green-800 to-green-900 font-sans" },
            !gameId ? renderLobby() : renderGame()
          );
        }

        // --- Componentes Filhos ---
        function GameCard({ player, isEliminated, onClick }) {
          return React.createElement('button', {
            onClick: onClick,
            className: `relative w-full overflow-hidden transition-all duration-300 transform border-2 border-gray-700 rounded-lg shadow-lg aspect-square group ${isEliminated ? 'opacity-20 scale-95' : 'hover:scale-105 hover:shadow-xl'}`
          },
            React.createElement('img', {
              src: player.imageUrl,
              alt: player.name,
              className: "object-cover w-full h-full",
              onError: (e) => { e.target.onerror = null; e.target.src='https://placehold.co/200x200/cccccc/999999?text=Erro'; }
            }),
            React.createElement('div', { className: `absolute bottom-0 left-0 right-0 p-2 text-center text-white transition-opacity duration-300 bg-black bg-opacity-70 ${isEliminated ? 'opacity-0' : 'opacity-100'}` },
              React.createElement('p', { className: "text-xs font-bold truncate md:text-sm" }, player.name)
            ),
            isEliminated && React.createElement('div', { className: "absolute inset-0 flex items-center justify-center" },
              React.createElement('span', { className: "text-8xl font-black text-red-600 opacity-80", style: { textShadow: '0 0 10px rgba(0,0,0,0.7)' } }, "X")
            )
          );
        }

        function GuessModal({ board, onClose, onGuess }) {
          return React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-75" },
            React.createElement('div', { className: "w-full max-w-4xl p-6 bg-white rounded-lg shadow-xl max-h-[90vh] overflow-y-auto" },
              React.createElement('div', { className: "flex items-center justify-between mb-4" },
                React.createElement('h2', { className: "text-2xl font-bold text-gray-800" }, "Qual √© o seu jogador secreto?"),
                React.createElement('button', { onClick: onClose, className: "text-2xl font-bold text-gray-500 hover:text-gray-800" }, "√ó")
              ),
              React.createElement('p', { className: "mb-6 text-gray-600" }, "Clique no jogador que voc√™ acha que √©."),
              React.createElement('div', { className: "grid grid-cols-3 gap-4 sm:grid-cols-4 md:grid-cols-5" },
                board.map(player => (
                  React.createElement('button', {
                    key: player.id,
                    onClick: () => onGuess(player.id),
                    className: "relative w-full overflow-hidden transition-all duration-200 transform border-2 border-transparent rounded-lg shadow-md aspect-square group hover:scale-105 hover:shadow-lg hover:border-blue-500"
                  },
                    React.createElement('img', {
                      src: player.imageUrl,
                      alt: player.name,
                      className: "object-cover w-full h-full",
                      onError: (e) => { e.target.onerror = null; e.target.src='https://placehold.co/200x200/cccccc/999999?text=Erro'; }
                    }),
                    React.createElement('div', { className: "absolute bottom-0 left-0 right-0 p-2 text-xs font-bold text-center text-white truncate transition-opacity duration-300 bg-black bg-opacity-70 group-hover:bg-blue-600" },
                      player.name
                    )
                  )
                ))
              ),
              React.createElement('button', {
                onClick: onClose,
                className: "w-full px-4 py-2 mt-8 font-semibold text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
              }, "Cancelar")
            )
          );

        }

        // --- Monta a aplica√ß√£o React ---
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(React.createElement(App));

    </script>
</body>
</html>
